{% extends 'base.twig' %}

{% block title %}Rey Complex Figure task{% endblock %}
{% block css %}
    <style type="text/css">
        img.img-responsive {
            margin: 0 auto;
        }

        .step h3.popover-title {
            margin-bottom: 0;
        }
    </style>
{% endblock %}
{% block content %}
    <section class="container" id="main">
        <div id="survey_container">
            <form name="reyComplexFigure3" id="wrapped" action="" method="POST">
                <!-- RCFT1 -->
                <div id="middle-wizard">
                    <div class="step row">
                        <div class="col-md-12 ">
                            <h4>
                                <center>
                                    {{ RCFTInsructions3 | raw }}
                                </center>
                            </h4>
                        </div>
                    </div>
                    <div class="step row">
                        <!-- <h4>Rey Complex Figure Part 3 (30 Min Mark)</h4> -->
                        <div id="canvas-drawing">
                            <canvas id='RCFT3' class="center-block" width="600" height="470" style="border:1px solid #000000;"></canvas>
                        </div>
                        <br>
                    </div>
                    <input type="hidden" id="timer" name="drawingTimes"  value=0>
                    <div class="submit step" id="complete">
                        <i class="icon-check"></i>
                        <h3>{{ RCFTTestComplete | raw }}</h3>
                        <button type="submit" name="process" class="submit">{{ RCFTSubmit | raw }}</button>
                    </div><!-- end submit step -->
                </div>
                <div id="bottom-wizard">
                    <button id="backwardButton" type="button" name="backward" class="backward">{{ RCFTBackward |raw }}</button>
                    <button id="forwardButton" type="button" name="forward" class="forward">{{ RCFTForward | raw }}</button>
                </div>
            </form>
        </div><!-- end Survey container -->
    </section>
{% endblock %}
{% block extra %}{% endblock %}
{% block script %}
    <script type="text/javascript" src="/assets/js/jcanvas.min.js"></script>
    <script type="text/javascript" src="/assets/js/jTimer.js"></script>
    <script>
        function callNativeApp () {
            try {
                webkit.messageHandlers.callbackHandler.postMessage("camera");
            } catch(err) {
                console.log('The native context does not exist yet');
            }
        }

        $(document).ready(function () {
            var $canvas2 = $("#RCFT3");
            var ptsArray = [];
            var lineObj= {};
            var isDown = false;
            var movingVar = 0;
            //Timers for the drawing stuff
            var timerStartedYet = 0;

            var drawingObject = {
                mousedown: function (layer) {
                    //Check to see if this is the users first time drawing, if it is, start time, set bool to true
                    if(timerStartedYet == 0 ){
                        //Set the field to the start value
                        var timeStart = performance.now();
                        document.getElementById('timer').value = timeStart;
                        timerStartedYet =1;
                        console.log("Start time " + timeStart);
                    }
                    movingVar++;
                    lineObj = {
                        layer: true,
                        type: 'line',
                        name: "practice" + movingVar,
                        strokeStyle: "#000",
                        strokeWidth: 2
                    };

                    isDown = true;
                    ptsArray.push([layer.eventX, layer.eventY]);

                    $(this).addLayer(lineObj).drawLayers();
                    $(this).moveLayer("practice" + movingVar, 0);
                },
                mousemove: function (layer) {
                    if (isDown) {
                        ptsArray.push([layer.eventX, layer.eventY]);
                        for (var p = 0; p < ptsArray.length; p += 1) {
                            lineObj['x' + (p + 1)] = ptsArray[p][0];
                            lineObj['y' + (p + 1)] = ptsArray[p][1];
                        }
                        $(this).drawLine(lineObj);
                    }
                },
                mouseup: function (layer) {
                    $(this).setLayer("practice" + movingVar, lineObj).drawLayers();

                    lineObj = {};
                    ptsArray = [];
                    isDown = false;
                },
                mouseout: function (layer) {
                    $(this).setLayer("practice" + movingVar, lineObj).drawLayers();
                }
            };

            $canvas2.drawRect({
                layer: true,
                x: 0, y: 0,
                width: 600, height: 470,
                fromCenter: false,
                name: 'canvas3'
            }).setLayer('canvas3', drawingObject);

            //Submission of test
            $('form').on('submit', function(e) {
                var c = document.getElementById("RCFT3");
                var dataURL = c.toDataURL("image/png");
                /*window.open(c.toDataURL('image/png'));*/

                //Calculate time taken for this test
                var startTime = document.getElementById('timer').value;
                var endTime = performance.now();
                var elapsedTime = endTime - startTime;
                var userID = getUrlVars()['id'];
                console.log("Elapsed time = " + elapsedTime);

                var data = {
                    imgBase64: dataURL,
                    timeTaken: elapsedTime,
                    name: "reyComplexFigure3"
                };

                $.post("http://api.girlscouts.harryatwal.com/participant/" + userID + "/reyComplexFigure3", data)
                        .done(function (o) {
                            console.log('saved');
                        });

                callNativeApp();
                e.preventDefault();
            });


        });

    </script>
{% endblock %}
